<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='logo.png') }}" type="image/x-icon">
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/x-icon">

    <!-- og:properties -->
    <meta property="og:title" content="MEAT-UP"/>
    <meta property="og:description" content="ë§›ì§‘ì„ í•¨ê»˜ ì¦ê²¨ìš”!"/>
    <meta property="og:image" content="{{ url_for('static', filename='og_img.jpg') }}"/>

    <!-- Webpage Title -->
    <title>MEAT-UP - ë§›ì§‘ì„ í•¨ê»˜ ì¦ê²¨ìš”!</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">

    <!-- Font Awesome CSS -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Stylish&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='mystyle.css') }}" rel="stylesheet">

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300&family=Sunflower:wght@500&display=swap"
          rel="stylesheet">

    <script>
        function sign_out() {
            $.removeCookie('mytoken', {path: '/'});
            alert('ë¡œê·¸ì•„ì›ƒ!')
            window.location.href = "/login"
        }

        function redirect_to_endup() {
            $.ajax({
                type: "GET",
                url: '/api/endup_view',
                data: {},
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            });
        }

        function save_gathering() {
            let title = $('#title').val()
            let date = $('#date').val()
            let agenda = $('#agenda').val()
            let max_guests = $('#max_guests').val()
            let location = $('#location').val()
            let restaurant = $('#restaurant').val()
            console.log(max_guests)
            let title1 = title
            if (title1 == "") {
                alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”")
                return
            }
            if (max_guests <= 1) {
                alert('ëª¨ì„ ìµœëŒ€ì¸ì›ì€ ë‘ ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤')
                return
            }

            $.ajax({
                type: "POST",
                url: '/api/gathering_create',
                data: {
                    title_give: title,
                    date_give: date,
                    agenda_give: agenda,
                    max_guests_give: max_guests,
                    location_give: location,
                    restaurant_give: restaurant,
                },
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            });
        }

        function endup_gathering(input_title, input_star, input_review) {
            let title = input_title
            let star = input_star
            let review = input_review
            $.ajax({
                type: "POST",
                url: '/api/endup_gathering',
                data: {
                    title_give: title,
                    star_give: star,
                    review_give: review
                },
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            });
        }

        // ì–´ë–¤ ë²„íŠ¼(ì°¸ê°€, ì·¨ì†Œ)ìœ¼ë¡œ ì°¸ê°€í–ˆëƒì— ë”°ë¼ì„œ ì¸ìë¥¼ ë”°ë¡œ ì „ë‹¬
        // ex : ì°¸ì„ ë²„íŠ¼ -> gathering_join(false)
        function gathering_join(bool_by_button, gathering_title) {
            let is_cancel = bool_by_button;
            //titleì€ ì¹´ë“œì—ì„œ ë”°ì˜¬ ì˜ˆì •, ì§€ê¸ˆì€ ì„ì‹œ
            let title = gathering_title;

            $.ajax({
                type: "POST",
                url: '/gathering_join',
                data: {
                    title_give: title,
                    is_cancel_give: is_cancel
                },
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            });
        }

        function update_gethering(title_rev, date_rev, agenda_rev, max_guests_rev, location_rev) {

            let max_guests_new = max_guests_rev

            if (max_guests_new <= 1) {
                alert('ëª¨ì„ ìµœëŒ€ì¸ì›ì€ ë‘ ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤')
                return
            }

            $.ajax({
                type: "POST",
                url: "/api/update",
                data: {
                    title_give: title_rev,
                    date_give: date_rev,
                    agenda_give: agenda_rev,
                    max_guests_give: max_guests_rev,
                    location_give: location_rev,
                    {#restaurant_give: restaurant_rev#}
                },
                success: function (response) {
                    alert(response["msg"])
                    window.location.href = '/';
                }
            });
        }

        function delete_gethering(title) {
            $.ajax({
                type: "POST",
                url: "/api/delete",
                data: {
                    title_give: title,
                },
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload();
                }
            });
        }
    </script>
</head>

<body class="has-navbar-fixed-top">
    <!--í™”ë©´ ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”-->
    <nav class="navbar is-fixed-top is-white" id="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">
                <img src="{{ url_for('static', filename='logo.png') }}">
                <strong class="is-sparta"style="font-family: 'Stylish', sans-serif;font-size: larger;">&nbsp;MEAT-UP</strong>
            </a>
        </div>
        <div id="btns-navbar">
            <button class="button is-success is-inverted" id="btn-navbar" onclick="window.location.href='/api/endup_view'">
                ëª¨ì„ í›„ê¸° ë³´ê¸°
            </button>
            <button class="button is-success is-inverted" id="btn-navbar" onclick="sign_out()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </nav>

    <!--ë³¸ë¬¸ ìƒë‹¨ ë²„íŠ¼-->
    <button class="button is-large" id="btn-create-gathering" onclick='$("#modal-post").addClass("is-active")'>ëª¨ì„ ë§Œë“¤ê¸°
    </button>

    <!--ë³¸ë¬¸ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸-->
    <section class="section" id="post_box2">
        <!--ë³¸ë¬¸ ì¹´ë“œ ê·¸ë¦¬ê¸°-->
        {% for gathering in gatherings|reverse %}
            <div id="post-box" class="container">
                <div class="box">
                    <article class="media">
                        <div class="media-left">
                            <div class="image is-64x64">
                                <!--img ì†ŒìŠ¤ ì ìš©-->
                                <img class="is-rounded"
                                     src="{{ gathering.food_img }}" alt="Image">
                            </div>
                        </div>
                        <div class="media-content">
                            <div class="content">
                                <p>
                                    <strong>{{ gathering.title }}</strong> <small>@{{ gathering.location }} / ì˜ˆì•½ ì¼ì
                                    : {{ gathering.date }}</small>
                                    <br>
                                    {{ joind_counter[gathering.title] }}/{{ gathering.max_guests }}ëª…
                                </p>
                            </div>
                            <nav class="level is-mobile">
                                <button class="button is-link" id="btn-gathering-detail"
                                        onclick='$("#modal-gathering{{ loop.index }}").addClass("is-active")'>ìì„¸íˆ ë³´ê¸°
                                </button>
                            </nav>
                        </div>
                    </article>
                </div>
            </div>

            <!--ìì„¸íˆë³´ê¸° í´ë¦­ ì‹œ ì—´ë¦¬ëŠ” ëª¨ë‹¬ ì¹´ë“œ ê·¸ë¦¬ê¸°-->
            <div class="modal" id="modal-gathering{{ loop.index }}">
                <div class="modal-background"
                     onclick='$("#modal-gathering{{ loop.index }}").removeClass("is-active")'>
                </div>

                <!--ëª¨ë‹¬ ë³¸ë¬¸-->
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">{{ gathering.title }}</p>
                        <button class="delete" aria-label="close"
                                onclick='$("#modal-gathering{{ loop.index }}").removeClass("is-active")'>
                        </button>
                    </header>
                    <section class="modal-card-body">
                        <div class="content">
                            <p>ë‚ ì§œ : {{ gathering.date }}</p>
                            <p>ë‚´ìš© : {{ gathering.agenda }}</p>
                            <p>ì¸ì›ìˆ˜ : {{ joind_counter[gathering.title] }} / {{ gathering.max_guests }}</p>
                            <p>ì¥ì†Œ : {{ gathering.location }}</p>
                            <p>ì‹ë‹¹(ìŒì‹) : {{ gathering.restaurant }}</p>
                        </div>
                    </section>

                    <!--ëª¨ë‹¬ í‘¸í„°-->
                    <footer class="modal-card-foot">
                        <!--ë¡œê·¸ì¸ í•œ ê³„ì •ê³¼ ê²Œì‹œê¸€ ìƒì„± ê³„ì • ì¼ì¹˜ ì—¬ë¶€ì— ë”°ë¼ ë¶„ê¸°-->
                        {% if userid == gathering.host %}
                            <button class="button is-success" id="btn-modal-gathering"
                                    onclick='$("#modal-gathering_update{{ loop.index }}").addClass("is-active")'>ìˆ˜ì •
                            </button>
                            <button class="button is-success" id="btn-modal-gathering"
                                    onclick="delete_gethering('{{ gathering.title }}')">
                                ì‚­ì œ
                            </button>
                            <button class="button is-success" id="btn-modal-gathering"
                                    onclick='$("#modal-gathering_endup{{ loop.index }}").addClass("is-active")'>í›„ê¸° ì‘ì„±
                            </button>
                        {% else %}
                            <button class="button is-success" id="btn-modal-gathering"
                                    onclick="gathering_join(0, '{{ gathering.title }}')">
                                ì°¸ì„ ì‹ ì²­
                            </button>
                            <button class="button is-success" id="btn-modal-gathering"
                                    onclick="gathering_join(1, '{{ gathering.title }}')">
                                ì°¸ì„ ì·¨ì†Œ
                            </button>
                        {% endif %}
                        <button class="button" id="btn-cancel"
                                onclick='$("#modal-gathering{{ loop.index }}").removeClass("is-active")'>
                            ëŒì•„ê°€ê¸°
                        </button>
                    </footer>
                </div>
            </div>
        {% endfor %}
    </section>

    <!--ëª¨ì„ë§Œë“¤ê¸° ì…ë ¥í™”ë©´-->
    <div class="modal" id="modal-post">
        <div class="modal-background" onclick='$("#modal-post").removeClass("is-active")'></div>
        <div class="modal-content">
            <div class="box">
                <article class="media">
                    <div class="media-content">
                        <!--ëª¨ì„ ìƒì„± ì…ë ¥í•„ë“œ-->
                        <div class="field">
                            <div id="gathering_create_box">
                                <div>ì œëª©<input class="input is-small" type="text" id="title" placeholder="ëª¨ì„ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."></div>
                                <br>
                                <div>ì¼ì <input class="input is-small" type="date" id="date"></div>
                                <br>
                                <div>ì„¤ëª… <textarea class="textarea is-small" placeholder="ëª¨ì„ ì£¼ì œ ë° ê³„íšì„ ì…ë ¥í•˜ì„¸ìš”." rows="10" id="agenda"></textarea></div>
                                <br>
                                <div>ìµœëŒ€ì¸ì› <input class="input is-small" type="number" id="max_guests" placeholder="ìµœëŒ€ì¸ì›ì€ '2ì¸ ì´ìƒ' ì…ë ¥í•˜ì„¸ìš”."></div>
                                <br>
                                <div>ì¥ì†Œ <input class="input is-small" type="text" id="location" placeholder="ëª¨ì¼ ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></div>
                                <br>
                                <div>ì‹ë‹¹(ìŒì‹) <input class="input is-small" type="text" id="restaurant" placeholder="ë°©ë¬¸í•  'ìŒì‹ì ' ë˜ëŠ” 'ìŒì‹ì¢…ë¥˜'ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></div>
                                <br>
                            </div>
                        </div>
                        <!--ëª¨ì„ ìƒì„± í‘¸í„°-->
                        <nav class="level is-mobile">
                            <div class="level-item">
                                <button class="button is-success" id="btn-modal-gathering" onclick="save_gathering()">
                                    ì €ì¥
                                </button>
                            </div>
                            <div class="level-item">
                                <button class="button" id="btn-cancel"
                                        onclick='$("#modal-post").removeClass("is-active")'>ì·¨ì†Œ
                                </button>
                            </div>
                        </nav>
                    </div>
                </article>
            </div>
        </div>
    </div>

    <!--ëª¨ì„í›„ê¸° ìƒì„±-->
    {% for gathering in gatherings|reverse %}
        <div class="modal" id="modal-gathering_endup{{ loop.index }}">
            <div class="modal-background"
                 onclick='$("#modal-gathering_endup{{ loop.index }}").removeClass("is-active")'>
            </div>
            <div class="modal-card">
                <!--ëª¨ì„í›„ ìƒë‹¨-->
                <header class="modal-card-head">
                    <p class="modal-card-title">{{ gathering.title }}</p>
                    <button class="delete" aria-label="close"
                            onclick='$("#modal-gathering_endup{{ loop.index }}").removeClass("is-active")'>
                    </button>
                </header>
                <!--ëª¨ì„í›„ê¸° ì…ë ¥í•„ë“œ-->
                <section class="modal-card-body">
                    <div class="content">
                        <div class="field">
                            <label class="label">ë§Œì¡±ë„</label>
                            <div class="control">
                                <div class="select is-rounded">
                                    <select id="star{{ loop.index }}">
                                        <option value="5">ğŸ‘ğŸ‘ğŸ‘ğŸ‘ğŸ‘</option>
                                        <option value="4">ğŸ‘ğŸ‘ğŸ‘ğŸ‘</option>
                                        <option value="3">ğŸ‘ğŸ‘ğŸ‘</option>
                                        <option value="2">ğŸ‘ğŸ‘</option>
                                        <option value="1">ğŸ‘</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">í›„ê¸°</label>
                        <div class="control">
                            <textarea class="textarea is-small" placeholder="í›„ê¸°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”!"
                                      id="review{{ loop.index }}"></textarea>
                        </div>
                    </div>
                </section>
                <!--ëª¨ì„í›„ê¸° í‘¸í„°-->
                <footer class="modal-card-foot">
                    {% if userid == gathering.host %}
                        <button class="button is-success" id="btn-modal-gathering"
                                onclick="endup_gathering('{{ gathering.title }}',$('#star{{ loop.index }}').val(),
                                        $('#review{{ loop.index }}').val())">ì €ì¥
                        </button>
                    {% endif %}
                    <button class="button" id="btn-cancel"
                            onclick='$("#modal-gathering_endup{{ loop.index }}").removeClass("is-active")'>
                        ëŒì•„ê°€ê¸°
                    </button>
                </footer>
            </div>
        </div>
    {% endfor %}

    <!--ëª¨ì„ì¹´ë“œ ìˆ˜ì •ì°½-->
    {% for gathering in gatherings|reverse %}
        <div class="modal" id="modal-gathering_update{{ loop.index }}">
            <div class="modal-background"
                 onclick='$("#modal-gathering_update{{ loop.index }}").removeClass("is-active")'></div>
            <div class="modal-card">
                <!--ëª¨ì„ì¹´ë“œ ìˆ˜ì • ìƒë‹¨-->
                <header class="modal-card-head">
                    <p class="modal-card-title" id="title_rev{{ loop.index }}">{{ gathering.title }}</p>
                    <button class="delete" aria-label="close"
                            onclick='$("#modal-gathering_update{{ loop.index }}").removeClass("is-active")'></button>
                </header>
                <!--ëª¨ì„ì¹´ë“œ ìˆ˜ì • ì…ë ¥í•„ë“œ-->
                <section class="modal-card-body">
                    <div class="content" id="modal-gathering_update{{ loop.index }}">
                        <div>ë‚ ì§œ : <input class="input is-small1" type="date" id="date_rev{{ loop.index }}"
                                         value="{{ gathering.date }}"></div>
                        <div>ë‚´ìš© : <input class="input is-small1" type="text" id="agenda_rev{{ loop.index }}"
                                         value="{{ gathering.agenda }}"></div>
                        <div>ì¸ì›ìˆ˜ : <input class="input is-small1" type="number" id="max_guests_rev{{ loop.index }}"
                                          value="{{ gathering.max_guests }}"></div>
                        <div>ì¥ì†Œ : <input class="input is-small1" type="text" id="location_rev{{ loop.index }}"
                                         value="{{ gathering.location }}"></div>
                        <br>
                        <div>ì‹ë‹¹(ìŒì‹) : {{ gathering.restaurant }} </div>
                    </div>
                </section>
                <!--ëª¨ì„ì¹´ë“œ ìˆ˜ì • í‘¸í„°-->
                <footer class="modal-card-foot">
                    {% if userid == gathering.host %}
                        <button class="button is-success" id="btn-modal-gathering"
                            onclick="update_gethering('{{ gathering.title }}', $('#date_rev{{ loop.index }}').val(),
                                    $('#agenda_rev{{ loop.index }}').val(), $('#max_guests_rev{{ loop.index }}').val(), $('#location_rev{{ loop.index }}').val(),
                                    $('#restaurant_rev{{ loop.index }}').val())">ì €ì¥
                        </button>
                    {% endif %}
                    <button class="button" id="btn-cancel"
                            onclick='$("#modal-gathering_update{{ loop.index }}").removeClass("is-active")'>
                        ëŒì•„ê°€ê¸°
                    </button>
                </footer>
            </div>
        </div>
    {% endfor %}
</body>
</html>
